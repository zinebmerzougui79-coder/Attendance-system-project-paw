<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Page</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #74b9ff, #0984e3);
    margin: 0;
    padding: 0;
    min-height: 100vh;
}

.navbar {
    background: rgba(255,255,255,0.9);
    padding: 15px;
    margin: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.navbar a {
    margin: 0 15px;
    text-decoration: none;
    color: #0984e3;
    font-weight: bold;
    padding: 8px 15px;
    border-radius: 5px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.navbar a:hover {
    background: #0984e3;
    color: white;
    transform: translateY(-2px);
}

.navbar a.active {
    background: #0984e3;
    color: white;
}

.container {
    width: 95%;
    max-width: 1200px;
    margin: 20px auto;
    padding: 25px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
    color: #0984e3;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

/* Controls */
.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
    align-items: center;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}

.search-box {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.search-box:focus {
    outline: none;
    border-color: #0984e3;
}

.btn {
    background: #0984e3;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn:hover {
    background: #065aa1;
    transform: translateY(-2px);
}

.btn.highlight {
    background: #f39c12;
}

.btn.highlight:hover {
    background: #e67e22;
}

.btn.reset {
    background: #e74c3c;
}

.btn.reset:hover {
    background: #c0392b;
}

.btn.report {
    background: #27ae60;
}

.btn.report:hover {
    background: #219a52;
}

/* Table */
.table-container {
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    min-width: 1000px;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

th {
    background: #0984e3;
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
}

/* Status Colors */
tr.green {
    background: #d4edda;
}

tr.yellow {
    background: #fff3cd;
}

tr.red {
    background: #f8d7da;
}

tr.highlighted {
    animation: pulse 2s infinite;
    border: 2px solid #f39c12;
}

@keyframes pulse {
    0% { background-color: #fff7dd; }
    50% { background-color: #ffeaa7; }
    100% { background-color: #fff7dd; }
}

tr:hover {
    background: #d0e7ff !important;
    cursor: pointer;
    transition: background 0.3s ease;
}

/* Checkbox Styles */
input[type="checkbox"] {
    transform: scale(1.2);
    cursor: pointer;
}

input[type="checkbox"]:checked {
    accent-color: #27ae60;
}

.attendCheck:checked {
    accent-color: #27ae60;
}

.partCheck:checked {
    accent-color: #3498db;
}

/* Messages */
.sort-message {
    background: #d1ecf1;
    color: #0c5460;
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #0c5460;
    display: flex;
    align-items: center;
    gap: 8px;
}

.message-cell {
    font-size: 12px;
    font-weight: 600;
    max-width: 200px;
}

/* Report Section */
#reportSection {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #0984e3;
}

.report-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #0984e3;
    display: block;
}

.stat-label {
    color: #7f8c8d;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .navbar {
        margin: 10px;
        padding: 10px;
    }

    .navbar a {
        margin: 2px;
        padding: 6px 10px;
        font-size: 12px;
    }

    .container {
        width: 98%;
        margin: 10px auto;
        padding: 15px;
    }

    .controls {
        flex-direction: column;
        align-items: stretch;
    }

    .search-box {
        min-width: unset;
    }

    .btn {
        justify-content: center;
    }

    table {
        font-size: 12px;
    }

    th, td {
        padding: 6px 4px;
    }
}
</style>
</head>
<body>

<nav class="navbar">
    <a href="index.html"><i class="fas fa-home"></i> Home</a>
    <a href="attendance.html" class="active"><i class="fas fa-list"></i> Attendance</a>
    <a href="add-student.html"><i class="fas fa-user-plus"></i> Add Student</a>
    <a href="reports.html"><i class="fas fa-chart-bar"></i> Report</a>
    <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
</nav>

<div class="container">
    <h2><i class="fas fa-list"></i> Attendance Management</h2>

    <div class="controls">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç Search by First or Last Name">
        <button class="btn" id="sortAbsencesBtn"><i class="fas fa-sort-amount-down"></i> Sort by Absences (Asc)</button>
        <button class="btn" id="sortParticipationBtn"><i class="fas fa-sort-amount-down-alt"></i> Sort by Participation (Desc)</button>
        <button class="btn highlight" id="highlightBtn"><i class="fas fa-star"></i> Highlight Excellent Students</button>
        <button class="btn reset" id="resetBtn"><i class="fas fa-sync"></i> Reset Colors</button>
        <button class="btn report" id="showReportBtn"><i class="fas fa-chart-bar"></i> Show Report</button>
    </div>

    <div id="sortMsg" class="sort-message" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="sortMessageText"></span>
    </div>

    <div class="table-container">
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th colspan="6">Attendance (Sessions 1-6)</th>
                    <th colspan="6">Participation (Sessions 1-6)</th>
                    <th>Absences</th>
                    <th>Participations</th>
                    <th>Message</th>
                </tr>
                <tr style="background: #2c3e50;">
                    <th colspan="3"></th>
                    <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>S6</th>
                    <th>P1</th><th>P2</th><th>P3</th><th>P4</th><th>P5</th><th>P6</th>
                    <th colspan="3"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="reportSection" style="display:none;">
        <h3 style="color: #2d3436; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-chart-pie"></i> Attendance Report
        </h3>
        <div class="report-stats" id="reportStats"></div>
        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <canvas id="attendanceChart" height="150"></canvas>
        </div>
    </div>
</div>

<script>
// Load students from localStorage
function loadStudents() {
    try {
        const saved = localStorage.getItem("students");
        console.log("üì¶ Loading students from localStorage...");
        
        if (saved && saved !== "undefined" && saved !== "null") {
            const students = JSON.parse(saved);
            console.log("‚úÖ Successfully loaded students:", students.length);
            return students;
        } else {
            console.log("üìù No students found, returning empty array");
            return [];
        }
    } catch (error) {
        console.error("‚ùå Error loading students:", error);
        return [];
    }
}

let students = loadStudents();

// Save students to localStorage
function saveStudents() {
    try {
        localStorage.setItem("students", JSON.stringify(students));
        console.log("üíæ Students saved:", students.length);
        return true;
    } catch (error) {
        console.error("‚ùå Error saving students:", error);
        return false;
    }
}

// Render table
function renderTable(){
    const tbody = $("#attendanceTable tbody");
    tbody.empty();
    
    console.log("üéØ Rendering table with", students.length, "students");

    if (students.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="17" style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <i class="fas fa-users" style="font-size: 3em; margin-bottom: 10px; display: block;"></i>
                    No students found. <a href="add-student.html" style="color: #0984e3;">Add some students</a> to get started.
                </td>
            </tr>
        `);
        return;
    }

    students.forEach((student, index) => {
        // Ensure student has required arrays
        if (!student.attendance) student.attendance = new Array(6).fill(false);
        if (!student.participation) student.participation = new Array(6).fill(false);
        
        const absences = student.attendance.filter(a => !a).length;
        const participations = student.participation.filter(p => p).length;
        
        let msg = "";
        let rowClass = "";
        
        if (absences < 3) {
            msg = "Good attendance ‚Äì Excellent participation";
            rowClass = "green";
        } else if (absences < 5) {
            msg = "Warning ‚Äì attendance low ‚Äì You need to participate more";
            rowClass = "yellow";
        } else {
            msg = "Excluded ‚Äì too many absences ‚Äì You need to participate more";
            rowClass = "red";
        }

        let tr = $(`
            <tr class="${rowClass}" data-id="${student.matricule}" data-index="${index}">
                <td style="font-weight: 600;">${student.matricule}</td>
                <td>${student.firstname}</td>
                <td>${student.lastname}</td>
                ${student.attendance.map((a, i) => 
                    `<td><input type="checkbox" class="attendCheck" data-index="${i}" ${a ? "checked" : ""}></td>`
                ).join('')}
                ${student.participation.map((p, i) => 
                    `<td><input type="checkbox" class="partCheck" data-index="${i}" ${p ? "checked" : ""}></td>`
                ).join('')}
                <td style="font-weight: 700; color: ${absences > 4 ? '#e74c3c' : absences > 2 ? '#f39c12' : '#27ae60'}">${absences}</td>
                <td style="font-weight: 700; color: #0984e3;">${participations}</td>
                <td class="message-cell">${msg}</td>
            </tr>
        `);
        tbody.append(tr);
    });
}

// Checkbox change handler
$(document).on("change", ".attendCheck, .partCheck", function(){
    const tr = $(this).closest("tr");
    const studentIndex = tr.data("index");
    const sessionIndex = $(this).data("index");
    
    console.log("üìù Updating student", studentIndex, "session", sessionIndex);
    
    if ($(this).hasClass("attendCheck")) {
        students[studentIndex].attendance[sessionIndex] = $(this).is(":checked");
    } else if ($(this).hasClass("partCheck")) {
        students[studentIndex].participation[sessionIndex] = $(this).is(":checked");
    }
    
    saveStudents();
    renderTable();
});

// Hover row highlight
$(document).on("mouseenter", "#attendanceTable tbody tr", function(){
    $(this).css("background", "#d0e7ff");
});

$(document).on("mouseleave", "#attendanceTable tbody tr", function(){
    // Restore original color based on class
    const rowClass = $(this).attr('class');
    if (rowClass.includes('green')) {
        $(this).css("background", "#d4edda");
    } else if (rowClass.includes('yellow')) {
        $(this).css("background", "#fff3cd");
    } else if (rowClass.includes('red')) {
        $(this).css("background", "#f8d7da");
    } else {
        $(this).css("background", "");
    }
});

// Click row message
$(document).on("click", "#attendanceTable tbody tr", function(e){
    // Don't trigger if clicking on checkboxes
    if ($(e.target).is('input[type="checkbox"]')) return;
    
    const studentIndex = $(this).data("index");
    const student = students[studentIndex];
    const absences = student.attendance.filter(a => !a).length;
    const participations = student.participation.filter(p => p).length;
    
    alert(`Student: ${student.firstname} ${student.lastname}\nStudent ID: ${student.matricule}\nAbsences: ${absences}\nParticipations: ${participations}\nCourse: ${student.course || 'Not specified'}`);
});

// Highlight excellent students
$("#highlightBtn").click(() => {
    $("#attendanceTable tbody tr").removeClass("highlighted");
    
    $("#attendanceTable tbody tr").each(function() {
        const studentIndex = $(this).data("index");
        const absences = students[studentIndex].attendance.filter(a => !a).length;
        
        if (absences < 3) {
            $(this).addClass("highlighted");
            $(this).fadeOut(100).fadeIn(500);
        }
    });
});

// Reset colors
$("#resetBtn").click(() => {
    $("#attendanceTable tbody tr").removeClass("highlighted");
    renderTable();
    $("#sortMsg").hide();
});

// Search functionality
$("#searchInput").on("keyup", function() {
    const val = $(this).val().toLowerCase();
    $("#attendanceTable tbody tr").filter(function() {
        const fname = $(this).find("td:eq(1)").text().toLowerCase();
        const lname = $(this).find("td:eq(2)").text().toLowerCase();
        $(this).toggle(fname.includes(val) || lname.includes(val));
    });
});

// Sort by absences
$("#sortAbsencesBtn").click(() => {
    let rows = $("#attendanceTable tbody tr").get();
    
    rows.sort((a, b) => {
        const aIndex = $(a).data("index");
        const bIndex = $(b).data("index");
        const aAbs = students[aIndex].attendance.filter(a => !a).length;
        const bAbs = students[bIndex].attendance.filter(a => !a).length;
        return aAbs - bAbs;
    });
    
    $.each(rows, (i, tr) => $("#attendanceTable tbody").append(tr));
    
    $("#sortMessageText").text("Currently sorted by Absences (ascending)");
    $("#sortMsg").show();
});

// Sort by participation
$("#sortParticipationBtn").click(() => {
    let rows = $("#attendanceTable tbody tr").get();
    
    rows.sort((a, b) => {
        const aIndex = $(a).data("index");
        const bIndex = $(b).data("index");
        const aPart = students[aIndex].participation.filter(p => p).length;
        const bPart = students[bIndex].participation.filter(p => p).length;
        return bPart - aPart;
    });
    
    $.each(rows, (i, tr) => $("#attendanceTable tbody").append(tr));
    
    $("#sortMessageText").text("Currently sorted by Participation (descending)");
    $("#sortMsg").show();
});

// Show report
$("#showReportBtn").click(() => {
    const total = students.length;
    const present = students.reduce((acc, s) => acc + s.attendance.filter(a => a).length, 0);
    const part = students.reduce((acc, s) => acc + s.participation.filter(p => p).length, 0);
    const totalAbsences = students.reduce((acc, s) => acc + s.attendance.filter(a => !a).length, 0);
    
    // Update report stats
    $("#reportStats").html(`
        <div class="stat-item">
            <span class="stat-value">${total}</span>
            <span class="stat-label">Total Students</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">${present}</span>
            <span class="stat-label">Total Presence</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">${part}</span>
            <span class="stat-label">Total Participation</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">${totalAbsences}</span>
            <span class="stat-label">Total Absences</span>
        </div>
    `);
    
    $("#reportSection").show();
    
    // Create chart
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Presence', 'Participation', 'Absences'],
            datasets: [{
                label: 'Session Statistics',
                data: [present, part, totalAbsences],
                backgroundColor: ['#27ae60', '#3498db', '#e74c3c'],
                borderColor: ['#219a52', '#2980b9', '#c0392b'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Sessions'
                    }
                }
            }
        }
    });
});

// Initialize
$(document).ready(() => {
    console.log("üöÄ Attendance page loaded");
    renderTable();
    
    // Auto-refresh every 3 seconds to catch new students
    setInterval(() => {
        const previousCount = students.length;
        students = loadStudents();
        if (students.length !== previousCount) {
            console.log("üîÑ New students detected, refreshing table...");
            renderTable();
        }
    }, 3000);
});

// Debug function
function debugStorage() {
    console.log("üîç DEBUG - LocalStorage:", localStorage.getItem("students"));
    console.log("üîç DEBUG - Students count:", students.length);
}
</script>

</body>
</html>